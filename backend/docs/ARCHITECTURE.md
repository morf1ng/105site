# Архитектура Backend-системы

## Обзор

Backend-система для управления проектами, построенная на **FastAPI** с использованием асинхронного подхода и **PostgreSQL** в качестве базы данных.

## Технологический стек

- **Framework**: FastAPI 0.104+
- **ORM**: SQLAlchemy (async)
- **База данных**: PostgreSQL (asyncpg)
- **Python**: 3.10+

## Структура проекта

```
dag-code-backend/
├── app/
│   ├── main.py          # Точка входа, настройка FastAPI приложения
│   ├── database.py      # Конфигурация подключения к БД
│   ├── models.py        # SQLAlchemy модели данных
│   ├── schemas.py       # Pydantic схемы для валидации
│   ├── projects.py      # CRUD роуты для проектов
│   └── migration.py     # Скрипт создания таблиц
├── docs/                # Документация
├── uploads/             # Хранилище загруженных файлов
└── requirements.txt     # Зависимости проекта
```

## Архитектурные слои

### 1. **Слой данных (Data Layer)**
- **Модели** (`models.py`): SQLAlchemy ORM модели с отношениями
- **База данных** (`database.py`): Асинхронное подключение через `asyncpg`
- **Миграции**: Автоматическое создание таблиц через `Base.metadata.create_all()`

### 2. **Слой бизнес-логики (Business Logic Layer)**
- **Роуты** (`projects.py`): Обработка HTTP запросов, валидация, работа с БД
- **Валидация**: Pydantic схемы для структурирования данных

### 3. **Слой представления (Presentation Layer)**
- **FastAPI приложение** (`main.py`): REST API эндпоинты
- **Swagger UI**: Автоматическая документация на `/docs`
- **Статические файлы**: Отдача изображений через `/uploads`

## Модель данных

### Основная сущность: Project

Проект представляет собой единую сущность со следующими компонентами:

```
Project
├── Основные поля (title, url, target, task, images)
├── AboutCompany (1-to-1) - информация о компании
├── Stages (1-to-many) - этапы проекта
├── Result (1-to-1) - результат проекта
│   └── ResultImages (1-to-many) - изображения результата
└── Progress (1-to-many) - показатели прогресса
```

### Связи между моделями

- **Project ↔ ProjectAboutCompany**: One-to-One
- **Project ↔ ProjectStage**: One-to-Many
- **Project ↔ ProjectResult**: One-to-One
- **ProjectResult ↔ ProjectResultImage**: One-to-Many
- **Project ↔ ProjectProgress**: One-to-Many

Все связи используют каскадное удаление (`CASCADE`) для целостности данных.

## Особенности реализации

### Асинхронность
- Все операции с БД выполняются асинхронно через `AsyncSession`
- Использование `selectinload` для эффективной загрузки связанных объектов
- Предотвращение проблем с lazy loading через eager loading

### Работа с файлами
- Загрузка файлов через `multipart/form-data`
- Каталоги: `uploads/` (общие файлы), `uploads/stages/` (изображения этапов), `uploads/results/` (изображения результатов)
- В БД сохраняются относительные пути (например, `stages/phase1.png`), что упрощает отдачу через `/uploads/{path}`
- Статическая отдача файлов через FastAPI StaticFiles

### Валидация данных
- JSON-поля передаются как строки в form-data и парсятся на сервере
- Валидация через Pydantic схемы
- Обработка ошибок с понятными сообщениями

## Безопасность

- Валидация всех входящих данных
- Защита от SQL-инъекций через ORM
- Обработка ошибок без раскрытия внутренней структуры

## Производительность

- Асинхронные запросы к БД
- Eager loading связанных объектов (selectinload)
- Оптимизация запросов через batch loading

## Масштабируемость

- Модульная структура с разделением на роутеры
- Легкое добавление новых сущностей
- Поддержка Docker для контейнеризации

